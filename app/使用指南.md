# KAPI iOS App 使用指南

智能账单识别 iOS 应用（SwiftUI 版本）

## ✨ 功能特点

- ✅ 从相册选择图片 (PhotosPicker)
- ✅ 拍照识别 (UIImagePickerController)
- ✅ 调用 Backend HTTP 服务
- ✅ 显示识别结果
- ✅ 快速模式和标准模式开关
- ✅ 跳过商品明细选项
- ✅ 性能统计显示
- ✅ 健康检查
- ✅ 加载动画

## 📦 已创建的文件

在 `/Users/linjx/Desktop/kapi/app/qiaoqiao/qiaoqiao/` 目录下：

1. **Models.swift** - 数据模型
   - `InvoiceItem` - 账单明细项
   - `Invoice` - 账单信息
   - `ScanResult` - 扫描结果

2. **APIService.swift** - 网络服务
   - `healthCheck()` - 健康检查
   - `scanBill()` - 扫描账单

3. **ContentView.swift** - 主页面
   - 图片选择（相册/相机）
   - 识别选项配置
   - 扫描按钮

4. **ResultView.swift** - 结果页面
   - 显示账单图片
   - 显示识别结果
   - 性能统计

## 🚀 使用步骤

### 1. 打开 Xcode 项目

```bash
cd /Users/linjx/Desktop/kapi/app/qiaoqiao
open qiaoqiao.xcodeproj
```

### 2. 添加文件到项目

在 Xcode 中：

1. **添加 Swift 文件**：
   - 右键点击左侧导航栏中的 `qiaoqiao` 文件夹
   - 选择 "Add Files to qiaoqiao..."
   - 浏览到 `/Users/linjx/Desktop/kapi/app/qiaoqiao/qiaoqiao/`
   - 选中以下文件（按住 ⌘ 多选）：
     - Models.swift
     - APIService.swift
     - ResultView.swift
   - **重要**：确保勾选：
     - ✓ "Copy items if needed"
     - ✓ "Create groups"
     - ✓ 目标 Target: "qiaoqiao"
   - 点击 "Add"

2. **ContentView.swift 已经存在**（已被替换为新内容）

### 3. 配置 Info.plist 权限

**方法一：在 Xcode 中手动配置**

1. 在左侧导航栏找到 `Info.plist` 文件并打开
2. 点击任意一行，然后点击 "+" 添加新条目
3. 添加以下权限：

   **相册权限**：
   - Key: `Privacy - Photo Library Usage Description`
   - Type: `String`
   - Value: `需要访问相册以选择账单图片进行识别`

   **相机权限**：
   - Key: `Privacy - Camera Usage Description`
   - Type: `String`
   - Value: `需要使用相机拍摄账单图片进行识别`

   **HTTP 请求权限**：
   - Key: `App Transport Security Settings`
   - Type: `Dictionary`
   - 展开后添加子项：
     - Key: `Allow Arbitrary Loads`
     - Type: `Boolean`
     - Value: `YES`

**方法二：直接编辑 Info.plist 源码**

右键点击 Info.plist → Open As → Source Code，在 `<dict>` 标签内添加：

```xml
<!-- 相册权限 -->
<key>NSPhotoLibraryUsageDescription</key>
<string>需要访问相册以选择账单图片进行识别</string>

<!-- 相机权限 -->
<key>NSCameraUsageDescription</key>
<string>需要使用相机拍摄账单图片进行识别</string>

<!-- 允许 HTTP 请求 -->
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
</dict>
```

### 4. 启动 Backend 服务

在终端中：

```bash
cd /Users/linjx/Desktop/kapi/backend
./start.sh
```

确认后端在 `http://localhost:8080` 上运行。

### 5. 运行应用

在 Xcode 中：
- 选择目标设备（模拟器或真机）
- 点击运行按钮（⌘R）

## 📱 使用流程

1. **启动应用**
   - 自动检查服务器连接
   - 显示连接状态（✓ 成功 / ✗ 失败）

2. **选择图片**
   - 点击「选择图片」从相册选择
   - 点击「拍照」使用相机拍摄

3. **配置选项**
   - 「快速模式」- 使用小模型，速度更快
   - 「跳过商品明细」- 仅识别商家名和总金额

4. **开始识别**
   - 点击「开始识别」按钮
   - 显示加载动画
   - 自动跳转到结果页面

5. **查看结果**
   - 基本信息（类型、商家、日期等）
   - 商品明细列表（最多显示 5 项）
   - 总金额
   - 性能统计

## 🔧 真机调试

### 修改服务器地址

在 **APIService.swift** 中修改：

```swift
@Published var baseURL = "http://YOUR_MAC_IP:8080"  // 改为你的 Mac IP 地址
```

获取 Mac IP：
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

### 配置签名

1. 在 Xcode 中选择项目
2. 选择 Target "qiaoqiao"
3. 在 "Signing & Capabilities" 中配置 Team
4. 连接 iPhone 并运行

## 📂 项目结构

```
qiaoqiao/
├── qiaoqiao/
│   ├── Models.swift              # 数据模型
│   ├── APIService.swift          # 网络服务
│   ├── ContentView.swift         # 主页面
│   ├── ResultView.swift          # 结果页面
│   ├── qiaoqiaoApp.swift         # App 入口
│   └── Info.plist                # 权限配置
└── qiaoqiao.xcodeproj            # Xcode 项目
```

## 🎨 界面说明

### 主页面（ContentView）
- 服务器状态指示器
- 图片预览区域（300pt 高度）
- 快速模式开关
- 跳过商品明细开关
- 选择图片按钮（蓝色）
- 拍照按钮（绿色）
- 开始识别按钮（橙色）
- 加载指示器

### 结果页面（ResultView）
- 账单图片预览（200pt 高度）
- 基本信息卡片
- 商品明细卡片（显示前 5 项）
- 总金额卡片（大号蓝色字体）
- 性能统计卡片

## ⚠️ 注意事项

1. **文件需要添加到 Xcode 项目**
   - 仅创建文件不够，必须在 Xcode 中添加到项目
   - 确保文件在 Target Membership 中勾选了 "qiaoqiao"

2. **真机调试**
   - 需要修改服务器地址为 Mac 的局域网 IP
   - 确保 iPhone 和 Mac 在同一网络

3. **相机功能**
   - 模拟器不支持相机
   - 需要在真机上测试拍照功能

4. **HTTP 权限**
   - 生产环境应该使用 HTTPS
   - 移除 `NSAllowsArbitraryLoads`

## 🐛 常见问题

### 1. 编译错误

确保所有文件都已添加到 Xcode 项目中：
- 在左侧导航栏查看文件是否存在
- 选中文件后查看右侧 Target Membership 是否勾选

### 2. 网络连接失败

检查：
- Backend 服务是否运行（`http://localhost:8080/health`）
- 服务器地址是否正确
- 防火墙设置

### 3. 权限问题

在 iOS 设置中检查应用权限：
设置 > qiaoqiao > 照片/相机

### 4. 相册选择器不显示

确保 Info.plist 中添加了相册权限描述

## 🆕 SwiftUI 特性

本项目使用 SwiftUI 构建，具有以下特点：

- **声明式 UI**：代码更简洁，易于维护
- **实时预览**：在 Xcode 中可以实时预览界面
- **现代化**：使用最新的 iOS API
- **响应式**：自动适配不同屏幕尺寸

## 📄 许可证

MIT License
